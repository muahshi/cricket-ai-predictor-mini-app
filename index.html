<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cricket Predictor (Tool Use Fix)</title>
    <!-- Telegram Web App SDK and Tailwind CSS for mobile-first design -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Professional Dark Theme */
        body {
            /* Telegram theme colors for seamless integration */
            background-color: var(--tg-theme-bg-color, #1f2937); /* Dark Slate Grey */
            color: var(--tg-theme-text-color, #e5e7eb); /* Light Grey text */
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #374151); /* Slightly lighter card */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem; /* rounded-xl equivalent */
        }
        .header-main {
            color: #10b981; /* Green for Free/Open */
        }
        .btn-predict {
            background-color: #ef4444; /* Red for Call to Action */
            color: #ffffff;
            transition: all 0.2s ease;
        }
        .btn-predict:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        input, select {
            background-color: var(--tg-theme-secondary-bg-color, #4b5563) !important;
            color: var(--tg-theme-text-color, #f3f4f6) !important;
            border: 1px solid #6b7280;
        }
        .spinner {
            border-top-color: #f3f4f6;
            border-right-color: #f3f4f6;
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
        .match-item {
            cursor: pointer;
            transition: background-color 0.1s;
            border-left: 5px solid #3b82f6; /* Blue indicator */
        }
        .match-item:hover {
             background-color: #4b5563;
        }
        .section-header {
            border-bottom: 2px solid #4b5563;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .highlight-text {
            color: #f97316; /* Orange highlight */
            font-weight: 700;
        }
        .affiliate-link {
            background-color: #0d9488; /* Teal for partner link */
            transition: all 0.2s ease;
        }
        .affiliate-link:hover {
            background-color: #0f766e;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <!-- Header -->
    <header class="w-full max-w-lg mb-6 text-center">
        <h1 class="text-3xl font-extrabold header-main mb-2">üèè CRICKET AI PREDICTOR (FREE)</h1>
        <p class="text-gray-400">Deep statistical analysis, koi login nahi, sab free.</p>
    </header>

    <!-- Main Content Card -->
    <div id="app-container" class="w-full max-w-lg card p-6">
        
        <!-- App Status Bar -->
        <div id="status-bar" class="text-center p-2 mb-4 rounded-lg text-sm font-semibold bg-blue-700 text-blue-200">
            ‚úÖ App Ready. Match data load ho raha hai...
        </div>

        <!-- Today's Matches List Section -->
        <h2 class="text-lg font-bold mb-3 text-green-400">üî• Aaj Ke Live Matches (Data Google se)</h2>
        <div id="today-matches-list" class="space-y-3 mb-6">
            <!-- Matches and loading status will be displayed here -->
            <p id="match-list-status" class="text-center text-sm text-gray-400">Matches ki live list load ho rahi hai, please wait...</p>
        </div>

        <!-- Input Section for detailed analysis -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <label for="match-query" class="block text-sm font-medium text-gray-300">Detailed Report ke liye Match ka naam enter karein:</label>
            <input type="text" id="match-query" class="w-full p-3 rounded-lg border-none focus:ring-2 focus:ring-red-500" 
                   placeholder="e.g., India vs Pakistan 2nd T20I" aria-label="Enter Match Details">
            
            <button id="predict-button" class="btn-predict w-full p-3 text-lg font-extrabold rounded-lg flex items-center justify-center" onclick="handlePrediction()">
                <span id="button-text">üöÄ Detailed Analysis Generate Karein (FREE)</span>
                <div id="loading-spinner" class="w-5 h-5 border-4 rounded-full spinner animate-spin ml-2 hidden"></div>
            </button>
            <p class="text-center text-sm text-yellow-400 mt-2">Yeh service hamesha free rahegi.</p>
        </div>

        <!-- Result Section -->
        <div id="result-area" class="mt-8 space-y-4">
            <!-- Prediction results or message will be injected here -->
        </div>
        
    </div>


    <!-- Logic Script -->
    <script type="module">
        
        // --- CONFIGURATION ---
        const AFFILIATE_LINK = "https://your-betting-platform.com"; 
        const TELEGRAM_LINK = "https://t.me/your_telegram_channel"; 

        window.handlePrediction = handlePrediction;

        // --- TELEGRAM INIT ---
        window.onload = function() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand(); 
                if (Telegram.WebApp.themeParams) {
                    document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
                }
            }
            fetchTodayMatches();
        };

        // --- GEMINI API CALL UTILITY ---
        // API_KEY ko khali rakha gaya hai. Canvas ise run time par inject karega.
        const API_KEY =AIzaSyCtcUXO75GiuGEYp8WwhWqq0h4Cqi1X18E; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        async function fetchWithRetry(payload) {
            
            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    // API_KEY check
                    if (API_KEY === "AIzaSyCtcUXO75GiuGEYp8WwhWqq0h4Cqi1X18E" || API_KEY.startsWith("AIzaSy") === false) {
                        console.warn("API Key is missing or default. Relying on Canvas injection.");
                    }
                    
                    const fetchResponse = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (fetchResponse.status === 401) {
                        throw new Error("401 Unauthorized: Aapki API Key invalid hai. Canvas environment key inject nahi kar paya. Kripya Canvas ko refresh karein.");
                    }

                    if (!fetchResponse.ok) {
                        let errorDetail = await fetchResponse.text();
                        let errorMessage = `HTTP error! status: ${fetchResponse.status}.`;
                        try { 
                             const errorJson = JSON.parse(errorDetail);
                             // Extract only the necessary part of the error message for display
                             errorMessage += ` Detail: ${errorJson.error.message.substring(0, 100)}...`;
                        } catch (e) { 
                             errorMessage += ` Raw response: ${errorDetail.substring(0, 50)}...`; 
                        }
                        throw new Error(errorMessage);
                    }

                    return fetchResponse.json(); 

                } catch (error) {
                    // 401 error ya last attempt par error throw kar dena hai
                    if (error.message.includes("401 Unauthorized") || attempt === maxRetries - 1) {
                        throw error;
                    }
                    
                    attempt++;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
            }
            throw new Error("API request failed after all retries.");
        }


        // --- MATCH LIST FETCH ---
        async function fetchTodayMatches() {
            
            const listContainer = document.getElementById('today-matches-list');
            const statusMessage = document.getElementById('match-list-status');
            
            statusMessage.textContent = "Matches ki live list load ho rahi hai...";
            listContainer.innerHTML = ''; 
            listContainer.appendChild(statusMessage);

            // FIX: JSON output with googleSearch tool is unsupported. Using plain text format now.
            const systemPrompt = `Aap ek cricket match listing aur quick prediction expert hain. Aapka kaam hai aaj (current date) hone wale sabhi major international aur domestic cricket matches ko Google Search ka use karke dhundhna. Har match ke liye ek quick, statistically-based winning chance (percentage), winner team, aur saath mein ek chota sa teaser bhi dena hai.

            Response ka format strictly plain text mein hona chahiye, har match ek nayi line par aur har field pipe (|) se separated hona chahiye. Sirf data dena hai, koi extra text ya explanation nahi:
            Match Name | Winning Likelihood (Team A: X%, Team B: Y%) | Winner Team | Teaser Detail (Pitch, Venue short description)

            Example:
            India vs Pakistan, T20 World Cup | India: 65%, Pakistan: 35% | India | Flat pitch, high boundary factor.
            England vs Australia, Ashes | England: 48%, Australia: 52% | Australia | Cloudy conditions, early swing likely.`;

            const userQuery = "Aaj ke saare cricket matches, unki winning percentage, kon jeetega aur pitch/venue ka 1-line teaser batao.";
            
            // Payload without responseMimeType
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "googleSearch": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const rawText = candidate.content.parts[0].text;
                const matchLines = rawText.split('\n').filter(line => line.trim().includes('|'));
                
                listContainer.innerHTML = ''; 
                
                if (matchLines.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-sm text-red-400">Aaj koi major match nahi mila ya data abhi update nahi hua hai.</p>';
                    return;
                }

                matchLines.forEach(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length < 4) return; // Skip malformed lines

                    const [matchName, winningLikelihood, winnerTeam, teaserDetail] = parts;
                    
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item card p-3 flex flex-col space-y-2';
                    matchItem.setAttribute('data-match-name', matchName);
                    matchItem.onclick = () => handlePrediction(matchName); 

                    const winningTeam = winnerTeam || 'N/A';
                    const likelihoodParts = (winningLikelihood || '').split(',').map(s => s.trim());
                    
                    let likelihoodDisplay = likelihoodParts.map(part => {
                        // Simple check to highlight the predicted winner's odds
                        const isWinner = winningTeam !== 'N/A' && part.includes(winningTeam.split(' ')[0]); 
                        const colorClass = isWinner ? 'text-green-400 font-extrabold' : 'text-yellow-400 font-semibold';
                        return `<span class="${colorClass}">${part}</span>`;
                    }).join(' / ');


                    matchItem.innerHTML = `
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <p class="font-bold text-base text-white">${matchName}</p>
                            </div>
                            <div class="text-right text-xs font-mono">
                                ${likelihoodDisplay}
                            </div>
                        </div>
                        <div class="w-full border-t border-gray-600 pt-1">
                             <p class="text-xs text-gray-400">Expected Winner: <span class="text-green-400 font-bold">${winningTeam}</span></p>
                             <p class="text-xs text-orange-300 mt-1">üìç Teaser: ${teaserDetail || 'Koi quick info nahi mili.'}</p>
                        </div>
                    `;
                    listContainer.appendChild(matchItem);
                });

                const instruction = document.createElement('p');
                instruction.className = 'text-center text-xs text-gray-500 mt-2';
                instruction.textContent = 'Full Betting Report (Pitch, Key Battles, Toss) ke liye, match par TAP karein.';
                listContainer.appendChild(instruction);


            } catch (error) {
                console.error("Error fetching or parsing match list:", error);
                 // Display the specific error message for user clarity
                 const errorMessageDiv = `<div class="p-4 rounded-lg bg-red-900 border border-red-400">
                                            <p class="text-center text-xl font-bold text-red-300">üö® API/TOOL ERROR</p>
                                            <p class="text-center text-sm text-red-200 mt-2">Data load nahi ho saka. Yeh tool ya server ki galti hai. Kripya **Refresh** karein.</p>
                                            <p class="text-center text-xs text-red-500 mt-2">Detail: ${error.message}</p>
                                          </div>`;
                listContainer.innerHTML = errorMessageDiv;
            }
        }
        
        // --- GATEWAY FUNCTION ---
        function handlePrediction(matchNameFromList = null) {

            const queryInput = document.getElementById('match-query');
            let query;
            
            if (matchNameFromList) {
                query = matchNameFromList;
                queryInput.value = matchNameFromList; 
            } else {
                query = queryInput.value.trim();
            }

            if (!query) {
                displayMessage("Kripya match ka naam enter karein.", 'error');
                return;
            }
            
            runPrediction(query);
        }
        
        // --- DETAILED ANALYSIS EXECUTION ---
        async function runPrediction(query) {
            
            const loadingSpinner = document.getElementById('loading-spinner');
            const buttonText = document.getElementById('button-text');
            const predictButton = document.getElementById('predict-button');
            
            // UI State: Loading
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Deep Analysis Ho Rahi Hai...';
            predictButton.disabled = true;
            
            document.getElementById('result-area').innerHTML = '';
            displayMessage("Gemini AI deep statistical report bana raha hai. Please wait...", 'info');
            
            const systemPrompt = `Aap ek world-class cricket match analysis aur statistical prediction expert hain. Aapka kaam hai user ke diye gaye cricket match ke liye ek detailed, objective analysis dena. Aapki analysis ek betting karne wale person ko dhyan mein rakh kar ki jayegi. Aapko woh saare key insights dene hain jo ek expert ko chahiye hote hain.
            
            Response ka format strictly JSON hona chahiye.

            Apne analysis mein Google Search se current aur accurate data ka use karein.`;

            const userQuery = `Match: ${query}. Detailed betting analysis report do, jismein pitch, toss, key battles, aur score range ho. Jawab ko JSON format mein do jismein MatchName, OverallWinner, WinningProbability, PitchReport, TossDecisionPrediction, KeyBattles (array of {player1, player2, context}), TopPerformersLikely (object with {Batsmen, Bowlers}), aur FirstInningsScoreRange fields hon.`;
            
            // FIX: Since tool use is restricted with responseMimeType, we remove the tool for this call 
            // and rely on the model's knowledge/retrieval capability for structured JSON.
            // If the error persists, we must disable JSON output and use plain text for everything.
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Note: Removing tool use here to allow JSON output, as the API might be restricted.
                // tools: [{ "googleSearch": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            MatchName: { type: "STRING" },
                            OverallWinner: { type: "STRING" },
                            WinningProbability: { type: "STRING" },
                            PitchReport: { type: "STRING" },
                            TossDecisionPrediction: { type: "STRING" },
                            KeyBattles: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        player1: { type: "STRING" },
                                        player2: { type: "STRING" },
                                        context: { type: "STRING" }
                                    }
                                }
                            },
                            TopPerformersLikely: {
                                type: "OBJECT",
                                properties: {
                                    Batsmen: { type: "STRING" },
                                    Bowlers: { type: "STRING" }
                                }
                            },
                            FirstInningsScoreRange: { type: "STRING" }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const jsonText = candidate.content.parts[0].text;
                let predictionData;

                try {
                    predictionData = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error("API ka response JSON format mein nahi mila. Response: " + jsonText.substring(0, 50) + "...");
                }
                
                renderPrediction(predictionData);

                displayMessage("Full Betting Report Ready! ‚úÖ", 'success');
                
            } catch (error) {
                console.error("Prediction Error:", error);
                
                const errorMessageDiv = `<div class="p-4 rounded-lg bg-red-900 border border-red-400">
                                            <p class="text-center text-xl font-bold text-red-300">üö® PREDICTION FAILED</p>
                                            <p class="text-center text-sm text-red-200 mt-2">Report generate nahi ho saki. Internet ya server issue.</p>
                                            <p class="text-center text-xs text-red-500 mt-2">Detail: ${error.message}</p>
                                          </div>`;
                document.getElementById('result-area').innerHTML = errorMessageDiv;

            }

            // UI State: Finished
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'üöÄ Detailed Analysis Generate Karein (FREE)';
            predictButton.disabled = false;
        }

        function displayMessage(message, type) {
            const resultArea = document.getElementById('result-area');
            let messageDiv = document.getElementById('status-message');
            
            // Check if status-bar needs update or result-area needs update
            let targetDiv = (type === 'error' || type === 'info' || type === 'success') ? resultArea : document.getElementById('status-bar');

            if (type === 'error' || type === 'info' || type === 'success') {
                 // Use a temporary message div in the result area for transient messages
                 if (!messageDiv || !resultArea.contains(messageDiv)) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'status-message';
                    messageDiv.classList.add('mt-4', 'p-3', 'rounded-lg', 'text-sm', 'font-medium', 'text-center', 'text-white', 'border', 'border-opacity-30');
                    resultArea.prepend(messageDiv);
                 }
            } else {
                 // Use the main status bar at the top
                 messageDiv = document.getElementById('status-bar');
            }


            let bgColor, borderColor;
            if (type === 'error') {
                bgColor = 'bg-red-700';
                borderColor = 'border-red-400';
            } else if (type === 'info') {
                bgColor = 'bg-blue-700';
                borderColor = 'border-blue-400';
            } else if (type === 'success') {
                bgColor = 'bg-green-700';
                borderColor = 'border-green-400';
            } else {
                bgColor = 'bg-gray-700';
                borderColor = 'border-gray-400';
            }
            
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm font-medium text-center text-white border border-opacity-30 ${bgColor} ${borderColor}`;
            messageDiv.textContent = message;

            if (window.Telegram && Telegram.WebApp) {
                if (type === 'error' && !message.includes("401 Unauthorized")) {
                    // Use a more gentle alert for the user
                    Telegram.WebApp.showPopup({
                        title: 'Prediction Error',
                        message: message,
                        buttons: [{id: 'refresh', type: 'default', text: 'Refresh App'}]
                    }, (buttonId) => {
                        if (buttonId === 'refresh') {
                            window.location.reload();
                        }
                    });
                }
            }
        }

        function renderPrediction(data) {
            const resultArea = document.getElementById('result-area');
            const statusMessage = document.getElementById('status-message');
            if(statusMessage) { statusMessage.remove(); }
            
            resultArea.innerHTML = ''; 

            const winnerTeam = data.OverallWinner || 'N/A';
            
            let html = `
                <h2 class="text-2xl font-extrabold text-red-400 mb-4 section-header">${data.MatchName || 'Match Report'} - FULL BETTING REPORT</h2>

                <!-- WINNER & PROBABILITY -->
                <div class="card p-4 mb-6 border-l-4 border-green-500 shadow-xl">
                    <p class="text-xs font-semibold text-gray-400">‚úÖ FREE REPORT (Koi Limit Nahi)</p>
                    <h3 class="text-3xl font-extrabold text-green-400 mt-1">${winnerTeam}</h3>
                    <p class="text-sm mt-2 text-white">Odds: <span class="highlight-text">${data.WinningProbability || 'N/A'}</span></p>
                    <p class="text-xs text-gray-500 mt-2">Yeh prediction saare statistical factors ko dhyan mein rakhkar banayi gayi hai.</p>
                </div>

                <!-- PITCH, TOSS, SCORE (Full Free Access) -->
                <div class="card p-4 mb-6 space-y-4">
                    <div class="border-b border-gray-600 pb-3">
                        <h4 class="font-bold text-lg text-orange-400">üèüÔ∏è PITCH & SCORE ANALYSIS</h4>
                        <p class="text-sm mt-2 text-gray-300">**Pitch Report:** ${data.PitchReport || 'Pitch report abhi available nahi hai.'}</p>
                        <p class="text-sm mt-2 font-extrabold text-yellow-300">**Toss Decision Suggestion:** <span class="highlight-text">${data.TossDecisionPrediction || 'N/A'}</span></p>
                        <p class="text-sm mt-2 font-extrabold text-red-300">**Expected 1st Innings Score:** <span class="highlight-text">${data.FirstInningsScoreRange || 'N/A'}</span></p>
                    </div>
                </div>
                
                <!-- TOP PERFORMERS -->
                <div class="card p-4 mb-6 border-l-4 border-yellow-500">
                    <h3 class="font-bold text-lg text-yellow-400">üåü FANTASY/KEY PLAYERS</h3>
                    <div class="mt-2 space-y-2">
                        <p class="text-sm text-gray-300">üèè **Batsmen (Top Picks):** ${data.TopPerformersLikely?.Batsmen || 'N/A'}</p>
                        <p class="text-sm text-gray-300">‚öæ **Bowlers (Wicket Takers):** ${data.TopPerformersLikely?.Bowlers || 'N/A'}</p>
                    </div>
                </div>
            `;

            // Key Battles Section
            if (data.KeyBattles && data.KeyBattles.length > 0) {
                html += `
                    <div class="card p-4 mb-6 border-l-4 border-red-500">
                        <h3 class="font-bold text-lg text-red-400 mb-3">‚öîÔ∏è KEY BATTLES (Head-to-Head)</h3>
                        <ul class="space-y-3">
                `;
                data.KeyBattles.forEach(battle => {
                    html += `<li class="p-3 rounded-lg border border-gray-600" style="background-color: #1f2937;">
                                <span class="font-extrabold text-green-300">${battle.player1 || 'Player 1'}</span> vs <span class="font-extrabold text-yellow-300">${battle.player2 || 'Player 2'}</span>
                                <p class="text-xs text-gray-400 mt-1">${battle.context || 'Context not available.'}</p>
                             </li>`;
                });
                html += `</ul></div>`;
            }

            // --- CALL TO ACTION / AFFILIATE SECTION ---
            html += `
                <h3 class="text-xl font-extrabold text-center text-orange-400 mt-8 mb-4">üèÜ Aage Ki Strategy Aur Live Updates</h3>

                <!-- Betting Partner Link -->
                <a href="${AFFILIATE_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl affiliate-link font-extrabold text-center text-white text-lg mb-4 shadow-xl transition duration-200">
                    üí∞ Is Match Par Bet Karein! (Official Partner)
                </a>

                <!-- Telegram Group Link -->
                <a href="${TELEGRAM_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl bg-blue-600 hover:bg-blue-700 font-extrabold text-center text-white text-lg transition duration-200">
                    üì¢ Free Tips & Live Score Updates Ke Liye Group Join Karein
                </a>
                <p class="text-center text-xs text-gray-500 mt-2">Sari post-toss analysis aur final report Telegram channel mein share hoti hai.</p>
            `;

            resultArea.innerHTML = html;
        }
    </script>
</body>
</html>

            
            while (attempt < maxRetries) {
                try {
                    // API_KEY check
                    if (API_KEY === "" || API_KEY.startsWith("AIzaSyCtcUXO75GiuGEYp8WwhWqq0h4Cqi1X18E") === false) {
                        console.warn("API Key is missing or default. Relying on Canvas injection.");
                    }
                    
                    const fetchResponse = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (fetchResponse.status === 401) {
                        throw new Error("401 Unauthorized: Aapki API Key invalid hai. Canvas environment key inject nahi kar paya. Kripya Canvas ko refresh karein.");
                    }

                    if (!fetchResponse.ok) {
                        let errorDetail = await fetchResponse.text();
                        let errorMessage = `HTTP error! status: ${fetchResponse.status}.`;
                        try { 
                             const errorJson = JSON.parse(errorDetail);
                             errorMessage += ` Detail: ${errorJson.error.message.substring(0, 100)}...`;
                        } catch (e) { 
                             errorMessage += ` Raw response: ${errorDetail.substring(0, 50)}...`; 
                        }
                        throw new Error(errorMessage);
                    }

                    return fetchResponse.json(); 

                } catch (error) {
                    // 401 error ya last attempt par error throw kar dena hai
                    if (error.message.includes("401 Unauthorized") || attempt === maxRetries - 1) {
                        throw error;
                    }
                    
                    attempt++;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
            }
            throw new Error("API request failed after all retries.");
        }


        // --- MATCH LIST FETCH ---
        async function fetchTodayMatches() {
            
            const listContainer = document.getElementById('today-matches-list');
            const statusMessage = document.getElementById('match-list-status');
            
            statusMessage.textContent = "Matches ki live list load ho rahi hai...";
            listContainer.innerHTML = ''; 
            listContainer.appendChild(statusMessage);

            const systemPrompt = `Aap ek cricket match listing aur quick prediction expert hain. Aapka kaam hai aaj (current date) hone wale sabhi major international aur domestic cricket matches ko Google Search ka use karke dhundhna. Har match ke liye ek quick, statistically-based winning chance (percentage) aur saath mein ek chota sa teaser (Pitch aur Venue ke bare mein 12 words se kam ka description) bhi dena hai.

            Response ka format strictly JSON array of objects hona chahiye. Sirf matches ki list dena hai, koi extra text nahi:
            [
              {
                "matchName": "Team A vs Team B, Tournament Name",
                "winningLikelihood": "Team A: 60%, Team B: 40%",
                "winnerTeam": "Team A",
                "teaserDetail": "Wicket flat hai, high-scoring game expected."
              }
            ]`;

            const userQuery = "Aaj ke saare cricket matches, unki winning percentage, kon jeetega aur pitch/venue ka 1-line teaser batao.";
            
            const searchQueries = ["Today's cricket matches quick prediction", "Aaj ke cricket matches ki bhavishyavani"];

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // **** GOOGLE SEARCH TOOL FIX ****
                tools: [{ "googleSearch": {} }], // Correct Tool definition
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                matchName: { type: "STRING" },
                                winningLikelihood: { type: "STRING" },
                                winnerTeam: { type: "STRING" },
                                teaserDetail: { type: "STRING" }
                            }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const jsonText = candidate.content.parts[0].text;
                let matchesData;
                
                try {
                    matchesData = JSON.parse(jsonText);
                } catch (e) {
                    listContainer.innerHTML = `<p class="text-center text-sm text-yellow-400">üö® Data format mein error. Response: ${jsonText.substring(0, 150)}...</p>`;
                    return;
                }
                
                listContainer.innerHTML = ''; 
                
                if (!Array.isArray(matchesData) || matchesData.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-sm text-red-400">Aaj koi major match nahi mila ya data abhi update nahi hua hai.</p>';
                    return;
                }

                matchesData.forEach(match => {
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item card p-3 flex flex-col space-y-2';
                    matchItem.setAttribute('data-match-name', match.matchName);
                    matchItem.onclick = () => handlePrediction(match.matchName); 

                    const winningTeam = match.winnerTeam || 'N/A';
                    const likelihoodParts = (match.winningLikelihood || '').split(',').map(s => s.trim());
                    
                    let likelihoodDisplay = likelihoodParts.map(part => {
                        const isWinner = part.includes(winningTeam);
                        const colorClass = isWinner ? 'text-green-400 font-extrabold' : 'text-yellow-400 font-semibold';
                        return `<span class="${colorClass}">${part}</span>`;
                    }).join(' / ');


                    matchItem.innerHTML = `
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <p class="font-bold text-base text-white">${match.matchName}</p>
                            </div>
                            <div class="text-right text-xs font-mono">
                                ${likelihoodDisplay}
                            </div>
                        </div>
                        <div class="w-full border-t border-gray-600 pt-1">
                             <p class="text-xs text-gray-400">Expected Winner: <span class="text-green-400 font-bold">${winningTeam}</span></p>
                             <p class="text-xs text-orange-300 mt-1">üìç Teaser: ${match.teaserDetail || 'Koi quick info nahi mili.'}</p>
                        </div>
                    `;
                    listContainer.appendChild(matchItem);
                });

                const instruction = document.createElement('p');
                instruction.className = 'text-center text-xs text-gray-500 mt-2';
                instruction.textContent = 'Full Betting Report (Pitch, Key Battles, Toss) ke liye, match par TAP karein.';
                listContainer.appendChild(instruction);


            } catch (error) {
                console.error("Error fetching or parsing match list:", error);
                 // Display the specific error message for user clarity
                 const errorMessageDiv = `<div class="p-4 rounded-lg bg-red-900 border border-red-400">
                                            <p class="text-center text-xl font-bold text-red-300">üö® API/TOOL ERROR</p>
                                            <p class="text-center text-sm text-red-200 mt-2">Data load nahi ho saka. Yeh tool ya server ki galti hai. Kripya **Refresh** karein.</p>
                                            <p class="text-center text-xs text-red-500 mt-2">Detail: ${error.message}</p>
                                          </div>`;
                listContainer.innerHTML = errorMessageDiv;
            }
        }
        
        // --- GATEWAY FUNCTION ---
        function handlePrediction(matchNameFromList = null) {

            const queryInput = document.getElementById('match-query');
            let query;
            
            if (matchNameFromList) {
                query = matchNameFromList;
                queryInput.value = matchNameFromList; 
            } else {
                query = queryInput.value.trim();
            }

            if (!query) {
                displayMessage("Kripya match ka naam enter karein.", 'error');
                return;
            }
            
            runPrediction(query);
        }
        
        // --- DETAILED ANALYSIS EXECUTION ---
        async function runPrediction(query) {
            
            const loadingSpinner = document.getElementById('loading-spinner');
            const buttonText = document.getElementById('button-text');
            const predictButton = document.getElementById('predict-button');
            
            // UI State: Loading
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Deep Analysis Ho Rahi Hai...';
            predictButton.disabled = true;
            
            document.getElementById('result-area').innerHTML = '';
            displayMessage("Gemini AI deep statistical report bana raha hai. Please wait...", 'info');
            
            const systemPrompt = `Aap ek world-class cricket match analysis aur statistical prediction expert hain. Aapka kaam hai user ke diye gaye cricket match ke liye ek detailed, objective analysis dena. Aapki analysis ek betting karne wale person ko dhyan mein rakh kar ki jayegi. Aapko woh saare key insights dene hain jo ek expert ko chahiye hote hain.
            
            Response ka format strictly JSON hona chahiye:
            {
              "MatchName": "...",
              "OverallWinner": "Team A",
              "WinningProbability": "Team A: X%, Team B: Y%",
              "PitchReport": "Detailed analysis of the venue's pitch (e.g., pace/spin support, average first innings score, boundary sizes).",
              "TossDecisionPrediction": "Suggest the ideal decision (bat/bowl) after winning the toss and explain why (e.g., dew factor, record).",
              "KeyBattles": [
                {"player1": "Batsman Name", "player2": "Bowler Name", "context": "Why this matchup is crucial and who has the edge (e.g., pace/spin weakness)."},
              ],
              "TopPerformersLikely": {
                  "Batsmen": "Name 2-3 key batsmen likely to score big (with reason).",
                  "Bowlers": "Name 2-3 key bowlers likely to take wickets (with reason)."
              },
              "FirstInningsScoreRange": "Predict a realistic score range for the first innings (e.g., 160-175)."
            }
            
            Apne analysis mein Google Search se current aur accurate data ka use karein.`;

            const userQuery = `Match: ${query}. Detailed betting analysis report do, jismein pitch, toss, key battles, aur score range ho.`;
            // Search queries are not needed in the payload when using the auto-grounding feature
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // **** GOOGLE SEARCH TOOL FIX ****
                tools: [{ "googleSearch": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            MatchName: { type: "STRING" },
                            OverallWinner: { type: "STRING" },
                            WinningProbability: { type: "STRING" },
                            PitchReport: { type: "STRING" },
                            TossDecisionPrediction: { type: "STRING" },
                            KeyBattles: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        player1: { type: "STRING" },
                                        player2: { type: "STRING" },
                                        context: { type: "STRING" }
                                    }
                                }
                            },
                            TopPerformersLikely: {
                                type: "OBJECT",
                                properties: {
                                    Batsmen: { type: "STRING" },
                                    Bowlers: { type: "STRING" }
                                }
                            },
                            FirstInningsScoreRange: { type: "STRING" }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const jsonText = candidate.content.parts[0].text;
                let predictionData;

                try {
                    predictionData = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error("API ka response JSON format mein nahi mila. Response: " + jsonText.substring(0, 50) + "...");
                }
                
                renderPrediction(predictionData);

                displayMessage("Full Betting Report Ready! ‚úÖ", 'success');
                
            } catch (error) {
                console.error("Prediction Error:", error);
                
                const errorMessageDiv = `<div class="p-4 rounded-lg bg-red-900 border border-red-400">
                                            <p class="text-center text-xl font-bold text-red-300">üö® PREDICTION FAILED</p>
                                            <p class="text-center text-sm text-red-200 mt-2">Report generate nahi ho saki. Internet ya server issue.</p>
                                            <p class="text-center text-xs text-red-500 mt-2">Detail: ${error.message}</p>
                                          </div>`;
                document.getElementById('result-area').innerHTML = errorMessageDiv;

            }

            // UI State: Finished
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'üöÄ Detailed Analysis Generate Karein (FREE)';
            predictButton.disabled = false;
        }

        function displayMessage(message, type) {
            const resultArea = document.getElementById('result-area');
            let messageDiv = document.getElementById('status-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'status-message';
                messageDiv.classList.add('mt-4', 'p-3', 'rounded-lg', 'text-sm', 'font-medium', 'text-center', 'text-white', 'border', 'border-opacity-30');
                resultArea.prepend(messageDiv);
            }

            let bgColor, borderColor;
            if (type === 'error') {
                bgColor = 'bg-red-700';
                borderColor = 'border-red-400';
            } else if (type === 'info') {
                bgColor = 'bg-blue-700';
                borderColor = 'border-blue-400';
            } else if (type === 'success') {
                bgColor = 'bg-green-700';
                borderColor = 'border-green-400';
            } else {
                bgColor = 'bg-gray-700';
                borderColor = 'border-gray-400';
            }
            
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm font-medium text-center text-white border border-opacity-30 ${bgColor} ${borderColor}`;
            messageDiv.textContent = message;

            if (window.Telegram && Telegram.WebApp) {
                if (type === 'error' && !message.includes("401 Unauthorized")) {
                    Telegram.WebApp.showAlert(`Error: ${message}`);
                }
            }
        }

        function renderPrediction(data) {
            const resultArea = document.getElementById('result-area');
            const statusMessage = document.getElementById('status-message');
            if(statusMessage) { statusMessage.remove(); }
            
            resultArea.innerHTML = ''; 

            const winnerTeam = data.OverallWinner || 'N/A';
            
            let html = `
                <h2 class="text-2xl font-extrabold text-red-400 mb-4 section-header">${data.MatchName || 'Match Report'} - FULL BETTING REPORT</h2>

                <!-- WINNER & PROBABILITY -->
                <div class="card p-4 mb-6 border-l-4 border-green-500 shadow-xl">
                    <p class="text-xs font-semibold text-gray-400">‚úÖ FREE REPORT (Koi Limit Nahi)</p>
                    <h3 class="text-3xl font-extrabold text-green-400 mt-1">${winnerTeam}</h3>
                    <p class="text-sm mt-2 text-white">Odds: <span class="highlight-text">${data.WinningProbability || 'N/A'}</span></p>
                    <p class="text-xs text-gray-500 mt-2">Yeh prediction saare statistical factors ko dhyan mein rakhkar banayi gayi hai.</p>
                </div>

                <!-- PITCH, TOSS, SCORE (Full Free Access) -->
                <div class="card p-4 mb-6 space-y-4">
                    <div class="border-b border-gray-600 pb-3">
                        <h4 class="font-bold text-lg text-orange-400">üèüÔ∏è PITCH & SCORE ANALYSIS</h4>
                        <p class="text-sm mt-2 text-gray-300">**Pitch Report:** ${data.PitchReport || 'Pitch report abhi available nahi hai.'}</p>
                        <p class="text-sm mt-2 font-extrabold text-yellow-300">**Toss Decision Suggestion:** <span class="highlight-text">${data.TossDecisionPrediction || 'N/A'}</span></p>
                        <p class="text-sm mt-2 font-extrabold text-red-300">**Expected 1st Innings Score:** <span class="highlight-text">${data.FirstInningsScoreRange || 'N/A'}</span></p>
                    </div>
                </div>
                
                <!-- TOP PERFORMERS -->
                <div class="card p-4 mb-6 border-l-4 border-yellow-500">
                    <h3 class="font-bold text-lg text-yellow-400">üåü FANTASY/KEY PLAYERS</h3>
                    <div class="mt-2 space-y-2">
                        <p class="text-sm text-gray-300">üèè **Batsmen (Top Picks):** ${data.TopPerformersLikely?.Batsmen || 'N/A'}</p>
                        <p class="text-sm text-gray-300">‚öæ **Bowlers (Wicket Takers):** ${data.TopPerformersLikely?.Bowlers || 'N/A'}</p>
                    </div>
                </div>
            `;

            // Key Battles Section
            if (data.KeyBattles && data.KeyBattles.length > 0) {
                html += `
                    <div class="card p-4 mb-6 border-l-4 border-red-500">
                        <h3 class="font-bold text-lg text-red-400 mb-3">‚öîÔ∏è KEY BATTLES (Head-to-Head)</h3>
                        <ul class="space-y-3">
                `;
                data.KeyBattles.forEach(battle => {
                    html += `<li class="p-3 rounded-lg border border-gray-600" style="background-color: #1f2937;">
                                <span class="font-extrabold text-green-300">${battle.player1 || 'Player 1'}</span> vs <span class="font-extrabold text-yellow-300">${battle.player2 || 'Player 2'}</span>
                                <p class="text-xs text-gray-400 mt-1">${battle.context || 'Context not available.'}</p>
                             </li>`;
                });
                html += `</ul></div>`;
            }

            // --- CALL TO ACTION / AFFILIATE SECTION ---
            html += `
                <h3 class="text-xl font-extrabold text-center text-orange-400 mt-8 mb-4">üèÜ Aage Ki Strategy Aur Live Updates</h3>

                <!-- Betting Partner Link -->
                <a href="${AFFILIATE_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl affiliate-link font-extrabold text-center text-white text-lg mb-4 shadow-xl transition duration-200">
                    üí∞ Is Match Par Bet Karein! (Official Partner)
                </a>

                <!-- Telegram Group Link -->
                <a href="${TELEGRAM_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl bg-blue-600 hover:bg-blue-700 font-extrabold text-center text-white text-lg transition duration-200">
                    üì¢ Free Tips & Live Score Updates Ke Liye Group Join Karein
                </a>
                <p class="text-center text-xs text-gray-500 mt-2">Sari post-toss analysis aur final report Telegram channel mein share hoti hai.</p>
            `;

            resultArea.innerHTML = html;
        }
    </script>
</body>
</html>

